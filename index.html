<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sermons Archive</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: light dark; }
    html, body { height: 100%; }
    .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-neutral-50 text-neutral-900 dark:bg-neutral-950 dark:text-neutral-100">

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center p-4 bg-black/60 z-50">
    <div class="w-full max-w-4xl h-[80vh] bg-white dark:bg-neutral-900 rounded-2xl shadow-xl overflow-hidden flex flex-col">
      <div class="flex items-center justify-between px-4 py-3 border-b border-neutral-200 dark:border-neutral-800">
        <h3 id="modalTitle" class="font-semibold text-lg"></h3>
        <button id="modalClose" class="px-2 py-1 rounded-lg border border-neutral-300 dark:border-neutral-700">Close</button>
      </div>
      <div id="modalBody" class="flex-1 overflow-auto p-6"></div>
    </div>
  </div>

<script>
let filteredRows = [];
const COLS = { title: 'Title', date: 'Date', passage: 'Passage', docurl: 'DocURL', body: 'Body' };
const $ = (sel) => document.querySelector(sel);
function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s])); }
function nl2br(text) { return (text || "").replaceAll("\n", "<br>"); }

function openSermon(index) {
  const row = filteredRows[index];
  const title = row[COLS.title] || "Untitled";
  const date = row[COLS.date] ? ` â€” ${row[COLS.date]}` : "";
  const passage = row[COLS.passage] || "";
  const doc = row[COLS.docurl] || "";
  const body = row[COLS.body] || "";

  $("#modalTitle").textContent = `${title}${date}`;

  let inner = "";
  if (doc) {
    let previewUrl = doc.includes("/preview") ? doc : doc.replace("/edit", "/preview");
    if (previewUrl.includes("pub")) {
      previewUrl = previewUrl.replace("pub", "pub?embedded=true");
    }
    inner += `<iframe src="${previewUrl}" style="width:100%; height:100%; border:0;" loading="lazy"></iframe>`;
  } else {
    inner += `<div class=\"space-y-4 max-w-5xl mx-auto\">`;
    if (passage) inner += `<p class=\"text-sm text-neutral-500\">${escapeHtml(passage)}</p>`;
    if (body) inner += `<div class=\"prose prose-neutral max-w-none dark:prose-invert text-base leading-relaxed\">${nl2br(escapeHtml(body))}</div>`;
    inner += `</div>`;
  }

  $("#modalBody").innerHTML = inner;
  $("#modal").classList.remove("hidden");
  $("#modal").classList.add("flex");
}

$("#modalClose").addEventListener("click", () => {
  $("#modal").classList.add("hidden");
  $("#modal").classList.remove("flex");
});
</script>
</body>
</html>
